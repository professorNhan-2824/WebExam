<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title th:text="${nameExam} + ' - B√†i Tr·∫Øc Nghi·ªám'">B√†i Tr·∫Øc Nghi·ªám</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body {
      background-color: #f4f6f9;
      font-family: 'Arial', sans-serif;
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow-y: auto;
    }

    .quiz-container {
      background-color: white;
      border-radius: 15px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      padding: 30px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .btn-answer {
      margin: 5px;
      transition: all 0.3s ease;
    }

    .btn-answer.selected {
      background-color: #6c63ff !important;
      color: white !important;
      transform: scale(1.05);
    }

    #timer {
      font-size: 1.5rem;
      color: #6c63ff;
      font-weight: bold;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .quiz-title {
      font-size: 2.5rem;
      font-weight: bold;
      text-transform: uppercase;
      color: #6c63ff;
    }

    .fullscreen-warning {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0, 0, 0, 0.95);
      z-index: 9999;
      display: none;
      justify-content: center;
      align-items: center;
      color: white;
      text-align: center;
      font-size: 24px;
    }

    .warning-content {
      background-color: #dc3545;
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      max-width: 500px;
      width: 90%;
    }

    .countdown {
      font-size: 60px;
      font-weight: bold;
      color: #fff;
      margin: 20px 0;
    }

    .question-nav {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: rgba(255, 255, 255, 0.95);
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      max-height: 80vh;
      overflow-y: auto;
      border: 2px solid #6c63ff;
      display: none;
    }

    .nav-title {
      font-weight: bold;
      color: #6c63ff;
      margin-bottom: 10px;
      text-align: center;
      font-size: 14px;
    }

    .nav-btn {
      display: inline-block;
      margin: 3px;
      padding: 8px 12px;
      background-color: #e9ecef;
      color: #495057;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      min-width: 35px;
      transition: all 0.2s ease;
    }

    .nav-btn:hover {
      background-color: #6c63ff;
      color: white;
      transform: translateY(-1px);
    }

    .nav-btn.answered {
      background-color: #28a745;
      color: white;
    }

    .nav-btn.current {
      background-color: #ffc107;
      color: #212529;
      font-weight: bold;
    }

    .start-fullscreen {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(135deg, #6c63ff, #5a54cc);
      color: white;
      padding: 20px 40px;
      border: none;
      border-radius: 15px;
      font-size: 1.8rem;
      cursor: pointer;
      z-index: 1001;
      box-shadow: 0 8px 25px rgba(108, 99, 255, 0.3);
      transition: all 0.3s ease;
    }

    .start-fullscreen:hover {
      transform: translate(-50%, -50%) translateY(-2px);
      box-shadow: 0 12px 35px rgba(108, 99, 255, 0.4);
    }

    .quiz-content {
      display: none;
    }
  </style>
</head>
<body th:data-user-id="${idUser}" th:data-exam-id="${idExam}" th:data-user-name="${username}" th:data-exam-name="${nameExam}">
<!-- C·∫£nh b√°o vi ph·∫°m -->
<div id="fullscreenWarning" class="fullscreen-warning">
  <div class="warning-content">
    <h2><i class="bi bi-exclamation-triangle-fill"></i> C·∫¢NH B√ÅO!</h2>
    <p id="warningMessage">Ph√°t hi·ªán vi ph·∫°m quy ƒë·ªãnh thi!</p>
    <p>B√†i thi s·∫Ω t·ª± ƒë·ªông n·ªôp sau:</p>
    <div class="countdown" id="warningCountdown">5</div>
    <p><strong>Nh·∫•n Alt+Tab ho·∫∑c F11 ƒë·ªÉ quay l·∫°i ngay!</strong></p>
  </div>
</div>

<!-- Thanh ƒëi·ªÅu h∆∞·ªõng c√¢u h·ªèi -->
<div id="questionNav" class="question-nav">
  <div class="nav-title">Danh s√°ch c√¢u h·ªèi</div>
  <div id="navButtons"></div>
</div>

<!-- N√∫t b·∫Øt ƒë·∫ßu b√†i thi -->
<button id="startFullscreen" class="start-fullscreen">
  <i class="bi bi-fullscreen"></i> B·∫Øt ƒë·∫ßu b√†i ki·ªÉm tra
</button>

<!-- N·ªôi dung b√†i thi -->
<div class="container mt-5 quiz-content" id="quizContent">
  <div class="row">
    <div class="col-8 mx-auto">
      <h1 class="quiz-title text-center mb-4" th:text="${nameExam} ?: 'L√†m B√†i Tr·∫Øc Nghi·ªám'">L√†m B√†i Tr·∫Øc Nghi·ªám</h1>
      <div class="quiz-container">
        <div class="text-center mb-4">
          <div id="timer">20:00</div>
          <small class="text-muted">
            <i class="bi bi-shield-check"></i> Ch·∫ø ƒë·ªô b·∫£o m·∫≠t ƒë√£ b·∫≠t
          </small>
        </div>

        <!-- Danh s√°ch c√¢u h·ªèi t·ª´ Thymeleaf -->
        <div th:each="question, stat : ${questions}" class="card mb-3 question-card" th:attr="data-question-id=${question.idQuestion}, data-question-number=${stat.index + 1}">
          <div class="card-body">
            <h5 class="card-title">
              <span class="badge bg-primary me-2" th:text="'C√¢u ' + ${stat.index + 1}">C√¢u 1</span>
              <span th:text="${question.question}">C√¢u h·ªèi</span>
            </h5>
            <div class="row">
              <div class="col-md-6 mb-2">
                <button class="btn btn-outline-primary btn-answer w-100" th:attr="data-answer=${question.answer1}" th:text="'A: ' + ${question.answer1}"></button>
              </div>
              <div class="col-md-6 mb-2">
                <button class="btn btn-outline-primary btn-answer w-100" th:attr="data-answer=${question.answer2}" th:text="'B: ' + ${question.answer2}"></button>
              </div>
              <div class="col-md-6 mb-2">
                <button class="btn btn-outline-primary btn-answer w-100" th:attr="data-answer=${question.answer3}" th:text="'C: ' + ${question.answer3}"></button>
              </div>
              <div class="col-md-6 mb-2">
                <button class="btn btn-outline-primary btn-answer w-100" th:attr="data-answer=${question.answer4}" th:text="'D: ' + ${question.answer4}"></button>
              </div>
            </div>
            <div class="result-text" style="display:none;"></div>
            <input type="hidden" class="correct-answer" th:value="${question.correctAnswer}">
          </div>
        </div>

        <!-- N√∫t n·ªôp b√†i -->
        <div class="text-center mt-4">
          <button class="btn btn-success px-5 py-2" onclick="submitQuiz()">
            <i class="bi bi-send-fill me-2"></i>N·ªôp b√†i
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Bi·∫øn to√†n c·ª•c
  let timeLeft = 20 * 60; // Th·ªùi gian thi: 20 ph√∫t
  let isAltPressed = false; // Theo d√µi tr·∫°ng th√°i ph√≠m Alt
  let isQuizStarted = false; // Tr·∫°ng th√°i b·∫Øt ƒë·∫ßu b√†i thi
  let isQuizSubmitted = false; // Tr·∫°ng th√°i n·ªôp b√†i
  let warningTimer = null; // Timer cho c·∫£nh b√°o
  let countdownValue = 5; // Th·ªùi gian ƒë·∫øm ng∆∞·ª£c 5 gi√¢y
  let isWarningActive = false; // NgƒÉn nhi·ªÅu c·∫£nh b√°o ƒë·ªìng th·ªùi
  let wakeLock = null; // Kh√≥a m√†n h√¨nh
  const selectedAnswers = {}; // L∆∞u c√¢u tr·∫£ l·ªùi c·ªßa ng∆∞·ªùi d√πng

  // Tham chi·∫øu DOM
  const timerDisplay = document.getElementById('timer');
  const fullscreenWarning = document.getElementById('fullscreenWarning');
  const warningMessage = document.getElementById('warningMessage');
  const warningCountdown = document.getElementById('warningCountdown');
  const quizContent = document.getElementById('quizContent');
  const startFullscreenButton = document.getElementById('startFullscreen');
  const questionNav = document.getElementById('questionNav');
  const navButtons = document.getElementById('navButtons');

  // H√†m y√™u c·∫ßu ch·∫ø ƒë·ªô to√†n m√†n h√¨nh
  function requestFullscreen() {
    const element = document.documentElement;
    return (element.requestFullscreen?.() ||
            element.webkitRequestFullscreen?.() ||
            element.mozRequestFullScreen?.() ||
            element.msRequestFullscreen?.() ||
            Promise.reject('Fullscreen kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£'));
  }

  // Ki·ªÉm tra tr·∫°ng th√°i to√†n m√†n h√¨nh
  function isFullscreen() {
    return !!(document.fullscreenElement ||
            document.webkitFullscreenElement ||
            document.mozFullScreenElement ||
            document.msFullscreenElement);
  }

  // Hi·ªÉn th·ªã c·∫£nh b√°o vi ph·∫°m v·ªõi ƒë·∫øm ng∆∞·ª£c 5 gi√¢y
  function showWarning(message) {
    if (isQuizSubmitted || !isQuizStarted || isWarningActive) return;
    isWarningActive = true;

    // Tr·ª´ 30 gi√¢y th·ªùi gian thi
    penalizeTime(30);
    // Ghi log v√† th√¥ng b√°o gi√°m kh·∫£o
    logViolation(message);
    notifyProctor(message);

    // Hi·ªÉn th·ªã c·∫£nh b√°o
    warningMessage.textContent = message;
    fullscreenWarning.style.display = 'flex';
    countdownValue = 5;
    warningCountdown.textContent = countdownValue;

    // X√≥a timer c≈© n·∫øu c√≥
    if (warningTimer) clearInterval(warningTimer);

    // ƒê·∫øm ng∆∞·ª£c 5 gi√¢y
    warningTimer = setInterval(() => {
      countdownValue--;
      warningCountdown.textContent = countdownValue;
      if (countdownValue <= 0) {
        clearInterval(warningTimer);
        isWarningActive = false;
        submitQuiz(true, message);
      }
    }, 1000);
  }

  // ·∫®n c·∫£nh b√°o
  function hideWarning() {
    fullscreenWarning.style.display = 'none';
    if (warningTimer) {
      clearInterval(warningTimer);
      warningTimer = null;
    }
    isWarningActive = false;
  }

  // Ghi log vi ph·∫°m l√™n server
  function logViolation(message) {
    const userId = document.body.getAttribute('data-user-id');
    const examId = document.body.getAttribute('data-exam-id');
    const timestamp = new Date().toISOString();
    fetch('/log-violation', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId, examId, violation: message, timestamp })
    }).catch(err => console.error('L·ªói ghi log:', err));
  }

  // Th√¥ng b√°o gi√°m kh·∫£o qua server
  function notifyProctor(message) {
    const userId = document.body.getAttribute('data-user-id');
    const examId = document.body.getAttribute('data-exam-id');
    const timestamp = new Date().toISOString();
    fetch('/notify-proctor', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId, examId, violation: message, timestamp })
    }).catch(err => console.error('L·ªói th√¥ng b√°o gi√°m kh·∫£o:', err));
  }

  // Tr·ª´ th·ªùi gian thi (30 gi√¢y)
  function penalizeTime(seconds) {
    timeLeft = Math.max(0, timeLeft - seconds);
  }

  // Ph√°t hi·ªán tho√°t to√†n m√†n h√¨nh
  function handleFullscreenChange() {
    if (!isQuizStarted || isQuizSubmitted) return;
    setTimeout(() => {
      if (!isFullscreen()) {
        showWarning('Tho√°t kh·ªèi ch·∫ø ƒë·ªô to√†n m√†n h√¨nh');
      } else {
        hideWarning();
      }
    }, 100);
  }

  // Ph√°t hi·ªán chuy·ªÉn tab/·ª©ng d·ª•ng
  function handleVisibilityChange() {
    if (!isQuizStarted || isQuizSubmitted) return;
    if (document.hidden) {
      showWarning('Chuy·ªÉn sang tab/·ª©ng d·ª•ng kh√°c');
    } else {
      hideWarning();
    }
  }

  // S·ª± ki·ªán b·∫£o m·∫≠t
  document.addEventListener('fullscreenchange', handleFullscreenChange);
  document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
  document.addEventListener('mozfullscreenchange', handleFullscreenChange);
  document.addEventListener('msfullscreenchange', handleFullscreenChange);
  document.addEventListener('visibilitychange', handleVisibilityChange);

  // Ph√°t hi·ªán m·∫•t ti√™u ƒëi·ªÉm (c√≥ th·ªÉ do Alt+Tab)
  window.addEventListener('blur', () => {
    if (isQuizStarted && !isQuizSubmitted) {
      showWarning('C·ª≠a s·ªï thi m·∫•t ti√™u ƒëi·ªÉm (c√≥ th·ªÉ Alt+Tab)');
    }
  });

  window.addEventListener('focus', () => {
    if (isQuizStarted && !isQuizSubmitted) {
      hideWarning();
    }
  });

  // Ch·∫∑n ph√≠m t·∫Øt v√† ph√°t hi·ªán Alt+Tab
  document.addEventListener('keydown', (e) => {
    if (!isQuizStarted || isQuizSubmitted) return;

    if (e.key === 'Alt') {
      isAltPressed = true;
    } else if (e.key === 'Tab' && isAltPressed) {
      e.preventDefault();
      showWarning('S·ª≠ d·ª•ng Alt+Tab');
    } else if (e.key === 'Meta' || e.key === 'Control') {
      e.preventDefault();
      showWarning('S·ª≠ d·ª•ng ph√≠m Windows ho·∫∑c Ctrl');
    } else if (e.key === 'PrintScreen') {
      showWarning('C·ªë g·∫Øng ch·ª•p ·∫£nh m√†n h√¨nh');
    } else if (e.key === 'F12' ||
            (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'C' || e.key === 'J')) ||
            (e.ctrlKey && e.key === 'U')) {
      e.preventDefault();
      showWarning('C·ªë g·∫Øng m·ªü Developer Tools');
    } else if (e.key === 'F11') {
      e.preventDefault();
      if (!isFullscreen()) {
        requestFullscreen().then(hideWarning).catch(() => {
          showWarning('Kh√¥ng th·ªÉ v√†o ch·∫ø ƒë·ªô to√†n m√†n h√¨nh');
        });
      }
    }
  });

  document.addEventListener('keyup', (e) => {
    if (e.key === 'Alt') isAltPressed = false;
  });

  // Ch·∫∑n chu·ªôt ph·∫£i
  document.addEventListener('contextmenu', (e) => {
    if (isQuizStarted && !isQuizSubmitted) {
      e.preventDefault();
      showWarning('Nh·∫•n chu·ªôt ph·∫£i');
    }
  });

  // Ph√°t hi·ªán m·ªü tab m·ªõi
  const channel = new BroadcastChannel('quiz_channel');
  channel.onmessage = (event) => {
    if (event.data === 'new_tab_opened' && isQuizStarted && !isQuizSubmitted) {
      showWarning('Ph√°t hi·ªán m·ªü tab m·ªõi');
    }
  };
  window.addEventListener('load', () => {
    channel.postMessage('new_tab_opened');
  });

  // Ph√°t hi·ªán s·ª≠ d·ª•ng nhi·ªÅu m√†n h√¨nh
  window.addEventListener('resize', () => {
    if (isQuizStarted && !isQuizSubmitted) {
      const screenCount = window.screen.availWidth / window.innerWidth;
      if (screenCount > 1) {
        showWarning('Ph√°t hi·ªán s·ª≠ d·ª•ng nhi·ªÅu m√†n h√¨nh');
      }
    }
  });

  // B·ªô ƒë·∫øm th·ªùi gian thi
  function startTimer() {
    const timerInterval = setInterval(() => {
      const minutes = Math.floor(timeLeft / 60);
      const seconds = timeLeft % 60;
      timerDisplay.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
      if (timeLeft <= 300) timerDisplay.style.color = '#dc3545';
      if (timeLeft <= 0) {
        clearInterval(timerInterval);
        submitQuiz(true, 'H·∫øt th·ªùi gian');
      }
      timeLeft--;
    }, 1000);
  }

  // T·∫°o thanh ƒëi·ªÅu h∆∞·ªõng c√¢u h·ªèi
  function generateQuestionNav() {
    const questionCards = document.querySelectorAll('.question-card');
    navButtons.innerHTML = '';
    questionCards.forEach((card, index) => {
      const button = document.createElement('button');
      button.className = 'nav-btn';
      button.textContent = index + 1;
      button.setAttribute('data-question', index + 1);
      button.addEventListener('click', () => {
        document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('current'));
        button.classList.add('current');
        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
      });
      navButtons.appendChild(button);
    });
    questionNav.style.display = 'block';
  }

  // C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒëi·ªÅu h∆∞·ªõng khi ch·ªçn ƒë√°p √°n
  function updateNavStatus(questionNumber) {
    const navBtn = document.querySelector(`[data-question="${questionNumber}"]`);
    if (navBtn) navBtn.classList.add('answered');
  }

  // X·ª≠ l√Ω ch·ªçn ƒë√°p √°n
  document.querySelectorAll('.btn-answer').forEach(button => {
    button.addEventListener('click', function() {
      const questionCard = this.closest('.question-card');
      const questionId = questionCard.getAttribute('data-question-id');
      const questionNumber = questionCard.getAttribute('data-question-number');
      questionCard.querySelectorAll('.btn-answer').forEach(btn => btn.classList.remove('selected'));
      this.classList.add('selected');
      selectedAnswers[questionId] = this.getAttribute('data-answer');
      updateNavStatus(questionNumber);
    });
  });

  // N·ªôp b√†i thi
  function submitQuiz(isTimeout = false, reason = '') {
    if (isQuizSubmitted) return;
    isQuizSubmitted = true;
    timeLeft = 0;
    if (warningTimer) clearInterval(warningTimer);
    hideWarning();

    // Thu th·∫≠p d·ªØ li·ªáu c√¢u tr·∫£ l·ªùi
    const answersData = [];
    document.querySelectorAll('.question-card').forEach(questionCard => {
      const questionId = questionCard.getAttribute('data-question-id');
      const correctAnswer = questionCard.querySelector('.correct-answer').value;
      answersData.push({
        questionId: parseInt(questionId),
        selectedAnswer: selectedAnswers[questionId] || null,
        correctAnswer
      });
    });

    // Chu·∫©n b·ªã d·ªØ li·ªáu g·ª≠i server
    const userId = document.body.getAttribute('data-user-id');
    const examId = document.body.getAttribute('data-exam-id');
    const userName = encodeURIComponent(document.body.getAttribute('data-user-name'));
    const examName = encodeURIComponent(document.body.getAttribute('data-exam-name') || 'Unknown Exam');
    const answersParam = encodeURIComponent(JSON.stringify(answersData));
    const submitReason = reason ? `&reason=${encodeURIComponent(reason)}` : '';
    const url = `/submit-exam?userId=${userId}&examId=${examId}&userName=${userName}&examName=${examName}&answers=${answersParam}&timeout=${isTimeout}${submitReason}`;

    // X√°c nh·∫≠n n·ªôp b√†i
    if (isTimeout || confirm('B·∫°n c√≥ mu·ªën n·ªôp b√†i kh√¥ng?')) {
      if (isFullscreen()) {
        document.exitFullscreen().finally(() => {
          window.location.href = url;
        });
      } else {
        window.location.href = url;
      }
    } else {
      isQuizSubmitted = false;
    }
  }

  // Kh√≥a m√†n h√¨nh ƒë·ªÉ ngƒÉn ti·∫øt ki·ªám nƒÉng l∆∞·ª£ng
  async function requestWakeLock() {
    try {
      wakeLock = await navigator.wakeLock.request('screen');
      console.log('ƒê√£ b·∫≠t kh√≥a m√†n h√¨nh');
    } catch (err) {
      console.error('L·ªói kh√≥a m√†n h√¨nh:', err);
    }
  }

  // B·∫Øt ƒë·∫ßu b√†i thi
  function startQuiz() {
    if (!confirm(
            'üîí B√ÄI THI AN TO√ÄN\n\n' +
            'B√†i thi s·∫Ω chuy·ªÉn sang ch·∫ø ƒë·ªô to√†n m√†n h√¨nh.\n\n' +
            '‚ö†Ô∏è L∆ØU √ù QUAN TR·ªåNG:\n' +
            '‚Ä¢ Kh√¥ng ƒë∆∞·ª£c tho√°t kh·ªèi ch·∫ø ƒë·ªô to√†n m√†n h√¨nh\n' +
            '‚Ä¢ Kh√¥ng ƒë∆∞·ª£c Alt+Tab chuy·ªÉn ·ª©ng d·ª•ng\n' +
            '‚Ä¢ Kh√¥ng ƒë∆∞·ª£c nh·∫•n F12 ho·∫∑c m·ªü Developer Tools\n' +
            '‚Ä¢ M·ªói vi ph·∫°m s·∫Ω b·ªã tr·ª´ 30 gi√¢y v√† t·ª± ƒë·ªông n·ªôp b√†i sau 5 gi√¢y\n\n' +
            'B·∫°n ƒë√£ s·∫µn s√†ng?'
    )) return;

    requestFullscreen().then(() => {
      startFullscreenButton.style.display = 'none';
      quizContent.style.display = 'block';
      isQuizStarted = true;
      startTimer();
      generateQuestionNav();
      requestWakeLock();
      const firstQuestion = document.querySelector('.question-card');
      if (firstQuestion) firstQuestion.scrollIntoView({ behavior: 'smooth' });
    }).catch(err => {
      alert('Kh√¥ng th·ªÉ v√†o ch·∫ø ƒë·ªô to√†n m√†n h√¨nh. Vui l√≤ng th·ª≠ l·∫°i.');
      console.error('L·ªói to√†n m√†n h√¨nh:', err);
    });
  }

  // Kh·ªüi t·∫°o
  window.addEventListener('load', () => {
    startFullscreenButton.addEventListener('click', startQuiz);
  });

  // NgƒÉn r·ªùi trang khi ƒëang thi
  window.addEventListener('beforeunload', (e) => {
    if (isQuizStarted && !isQuizSubmitted) {
      e.preventDefault();
      e.returnValue = 'B·∫°n c√≥ ch·∫Øc mu·ªën r·ªùi kh·ªèi? B√†i thi s·∫Ω kh√¥ng ƒë∆∞·ª£c l∆∞u.';
      return e.returnValue;
    }
  });
</script>
</body>
</html>